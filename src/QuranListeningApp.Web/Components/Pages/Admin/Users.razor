@page "/admin/users"
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using QuranListeningApp.Application.Services
@using QuranListeningApp.Domain.Enums
@attribute [Authorize(Roles = "Admin")]
@inject UserService UserService
@inject NavigationManager Navigation

<PageTitle>المستخدمون</PageTitle>

<div class="users-container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0">المستخدمون</h3>
                <p class="text-muted mb-0">إدارة وعرض المستخدمين</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" @onclick="BackToDashboard">
                    <i class="fas fa-arrow-left me-2"></i>
                    العودة
                </button>
                @if (activeRole == UserRole.Student)
                {
                    <a href="/admin/import-students" class="btn btn-info">
                        <i class="fas fa-upload me-2"></i>
                        استيراد CSV
                    </a>
                }
                <button class="btn btn-success" @onclick="AddUser">
                    <i class="fas fa-plus me-2"></i>
                    إضافة
                </button>
            </div>
        </div>
    </div>

    <div class="filter-tabs">
        <button class="tab @(activeRole == null ? "active" : "")" @onclick="() => FilterByRole(null)">
            الكل (@totalCount)
        </button>
        <button class="tab @(activeRole == UserRole.Teacher ? "active" : "")" @onclick="() => FilterByRole(UserRole.Teacher)">
            معلمون (@teacherCount)
        </button>
        <button class="tab @(activeRole == UserRole.Student ? "active" : "")" @onclick="() => FilterByRole(UserRole.Student)">
            طلاب (@studentCount)
        </button>
    </div>

    @* Search box *@
    <div class="search-box">
        <input type="text" 
               class="search-input" 
               placeholder="بحث حسب الاسم، رقم الهوية، الصف، الهاتف، أو البريد الإلكتروني..." 
               @bind="searchQuery"
               @bind:event="oninput"
               @bind:after="ApplyFilters" />
        @if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            <button class="search-clear" @onclick="ClearSearch" title="مسح البحث">×</button>
        }
    </div>

    @* Sub-tabs for students to filter by active/inactive status *@
    @if (activeRole == UserRole.Student)
    {
        <div class="filter-subtabs">
            <button class="subtab @(activeStatusFilter == null ? "active" : "")" @onclick="() => FilterByStatus(null)">
                جميع الطلاب (@studentCount)
            </button>
            <button class="subtab @(activeStatusFilter == true ? "active" : "")" @onclick="() => FilterByStatus(true)">
                الطلاب النشطون (@activeStudentCount)
            </button>
            <button class="subtab @(activeStatusFilter == false ? "active" : "")" @onclick="() => FilterByStatus(false)">
                الطلاب غير النشطين (@inactiveStudentCount)
            </button>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading">جاري التحميل...</div>
    }
    else
    {
        <div class="user-list">
            @foreach (var user in filteredUsers)
            {
                <div class="user-card">
                    <div class="user-info" @onclick="() => EditUser(user.Id)">
                        <div class="user-name">@user.FullNameArabic</div>
                        <div class="user-meta">
                            <span class="badge @GetRoleBadgeClass(user.Role)">@GetRoleText(user.Role)</span>
                            @if (user.Role == UserRole.Student && !string.IsNullOrEmpty(user.GradeLevel))
                            {
                                <span class="grade">الصف @user.GradeLevel</span>
                            }
                        </div>
                        <div class="user-details">
                            <span>@user.Username</span>
                            @if (!string.IsNullOrEmpty(user.PhoneNumber))
                            {
                                <span>@user.PhoneNumber</span>
                            }
                        </div>
                    </div>
                    <div class="user-actions" @onclick:stopPropagation="true">
                        @if (user.Role == UserRole.Student)
                        {
                            <button class="btn btn-sm btn-outline-info me-2" 
                                    @onclick="() => ViewStudentReport(user.Id)" 
                                    title="عرض تقرير التقدم">
                                <i class="fas fa-chart-line"></i>
                            </button>
                        }
                        <button class="btn btn-sm btn-outline-primary" 
                                @onclick="() => EditUser(user.Id)" 
                                title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="user-status">
                        @if (user.IsActive)
                        {
                            <span class="status-active">●</span>
                        }
                        else
                        {
                            <span class="status-inactive">○</span>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .users-container {
        padding: 12px;
        direction: rtl;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-import {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: background-color 0.2s;
    }

    .btn-import:hover {
        background: #138496;
        text-decoration: none;
        color: white;
    }



    .page-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }

    .btn-add {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
    }

    .filter-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        overflow-x: auto;
    }

    .tab {
        padding: 8px 16px;
        border: none;
        background: #f5f5f5;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        white-space: nowrap;
    }

    .tab.active {
        background: #667eea;
        color: white;
    }

    .search-box {
        position: relative;
        margin-bottom: 16px;
    }

    .search-input {
        width: 100%;
        padding: 10px 40px 10px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        direction: rtl;
        transition: border-color 0.2s;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .search-clear {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        padding: 0;
        transition: background-color 0.2s;
    }

    .search-clear:hover {
        background: #5a6268;
    }

    .filter-subtabs {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        margin-bottom: 16px;
        padding: 0 4px;
    }

    .subtab {
        padding: 6px 12px;
        border: none;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        white-space: nowrap;
        color: #666;
        border: 1px solid #e0e0e0;
    }

    .subtab.active {
        background: #e3f2fd;
        color: #1976d2;
        border-color: #1976d2;
    }

    .subtab:hover:not(.active) {
        background: #f0f0f0;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .user-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .user-card {
        background: white;
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }

    .user-info {
        flex: 1;
        cursor: pointer;
    }

    .user-info:active {
        transform: scale(0.98);
    }

    .user-actions {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-right: 10px;
    }

    .user-actions .btn {
        padding: 4px 8px;
        border-radius: 6px;
    }

    .user-name {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .user-meta {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 6px;
    }

    .badge {
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge.teacher {
        background: #e3f2fd;
        color: #1976d2;
    }

    .badge.student {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .grade {
        font-size: 12px;
        color: #666;
    }

    .user-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 12px;
        color: #666;
    }

    .user-status {
        font-size: 24px;
    }

    .status-active {
        color: #4CAF50;
    }

    .status-inactive {
        color: #ccc;
    }
</style>

@code {
    private List<Domain.Entities.User> allUsers = new();
    private List<Domain.Entities.User> filteredUsers = new();
    private UserRole? activeRole = null;
    private bool? activeStatusFilter = null; // null = all, true = active only, false = inactive only
    private string searchQuery = string.Empty;
    private bool isLoading = true;
    private int totalCount = 0;
    private int teacherCount = 0;
    private int studentCount = 0;
    private int activeStudentCount = 0;
    private int inactiveStudentCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        var users = await UserService.GetAllUsersAsync();
        allUsers = users.ToList();
        totalCount = allUsers.Count;
        teacherCount = allUsers.Count(u => u.Role == UserRole.Teacher);
        studentCount = allUsers.Count(u => u.Role == UserRole.Student);
        activeStudentCount = allUsers.Count(u => u.Role == UserRole.Student && u.IsActive);
        inactiveStudentCount = allUsers.Count(u => u.Role == UserRole.Student && !u.IsActive);
        FilterByRole(activeRole);
        isLoading = false;
    }

    private void FilterByRole(UserRole? role)
    {
        activeRole = role;
        activeStatusFilter = null; // Reset status filter when changing role
        ApplyFilters();
    }

    private void FilterByStatus(bool? isActive)
    {
        activeStatusFilter = isActive;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allUsers.AsEnumerable();

        // Filter by role
        if (activeRole.HasValue)
        {
            query = query.Where(u => u.Role == activeRole.Value);
        }

        // Filter by active status (only applies when viewing students)
        if (activeRole == UserRole.Student && activeStatusFilter.HasValue)
        {
            query = query.Where(u => u.IsActive == activeStatusFilter.Value);
        }

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            var search = searchQuery.Trim().ToLower();
            query = query.Where(u => 
                (u.FullNameArabic?.ToLower().Contains(search) ?? false) ||
                (u.IdNumber?.ToLower().Contains(search) ?? false) ||
                (u.PhoneNumber?.ToLower().Contains(search) ?? false) ||
                (u.Email?.ToLower().Contains(search) ?? false) ||
                (u.GradeLevel?.ToLower().Contains(search) ?? false) ||
                (u.Username?.ToLower().Contains(search) ?? false)
            );
        }

        filteredUsers = query.ToList();
    }

    private void ClearSearch()
    {
        searchQuery = string.Empty;
        ApplyFilters();
    }

    private string GetRoleText(UserRole role) => role switch
    {
        UserRole.Teacher => "معلم",
        UserRole.Student => "طالب",
        UserRole.Admin => "مدير",
        _ => ""
    };

    private string GetRoleBadgeClass(UserRole role) => role switch
    {
        UserRole.Teacher => "teacher",
        UserRole.Student => "student",
        _ => ""
    };

    private void AddUser() => Navigation.NavigateTo("/admin/users/add");
    private void EditUser(Guid id) => Navigation.NavigateTo($"/admin/users/edit/{id}");

    private void ViewStudentReport(Guid studentId) => Navigation.NavigateTo($"/admin/reports/student/{studentId}");
    private void BackToDashboard() => Navigation.NavigateTo("/admin");
}
